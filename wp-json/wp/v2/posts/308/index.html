{"id":308,"date":"2023-07-13T16:39:45","date_gmt":"2023-07-13T14:39:45","guid":{"rendered":"http:\/\/192.168.178.139\/?p=308"},"modified":"2023-11-16T17:59:31","modified_gmt":"2023-11-16T16:59:31","slug":"writing-a-cnc-workpiece-positioning-program","status":"publish","type":"post","link":"http:\/\/192.168.178.139\/writing-a-cnc-workpiece-positioning-program\/","title":{"rendered":"Writing a CNC Workpiece Positioning Program"},"content":{"rendered":"<p>The starting point for this next project was a defect in one of our CNC portal milling machines at my workplace, which is used for manufacturing staircase components. The defect did not directly involve the production system itself, but rather the projection laser used for setting up the vacuum clamps and for positioning the workpiece on the milling table.<\/p>\n<p>A conversation with the manufacturer revealed that the projection laser had already been discontinued and there were no longer any spare parts available for it. The only solution would have been a custom-made replacement, as the machine control only had an outdated RS232 interface, which was no longer installed by the manufacturer as a standard feature.<\/p>\n<p><strong><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-503 size-large\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_laser-1024x583.png\" alt=\"\" width=\"800\" height=\"455\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_laser-1024x583.png 1024w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_laser-300x171.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_laser-768x437.png 768w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_laser.png 1200w\" sizes=\"(max-width: 800px) 100vw, 800px\" \/><\/strong><\/p>\n<p>Considering the relatively high cost of several tens of thousands of euros for a new projection laser and the challenging circumstances involved in assembling and disassembling the laser system at around 6m from the ground, I opted for a software solution.<\/p>\n<p>In addition to the aforementioned points, an application for calculating the positioning of the workpiece and vacuum clamps provided a speed advantage, as it could also calculate the necessary zero-point shifts. Normally, the workpiece would be placed at a location determined by the CAM software and then manually adjusted due to the complex shape of the machine table. This trial-and-error process typically consumed a significant amount of time.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-494 size-large\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_reichenbacher-fornt-1024x561.jpg\" alt=\"\" width=\"800\" height=\"438\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_reichenbacher-fornt-1024x561.jpg 1024w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_reichenbacher-fornt-300x164.jpg 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_reichenbacher-fornt-768x421.jpg 768w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_reichenbacher-fornt.jpg 1446w\" sizes=\"(max-width: 800px) 100vw, 800px\" \/><\/p>\n<h2>Importing the G-Code<\/h2>\n<p>As a first step, it was necessary to read the G-code files into the development environment and locate the lines that defined the contours of the workpieces. To do this I leveraged the start and end strings that the CAM software provided. (WANGENKONTOUR) or (AUFG AUSSENK) as the start flag and M00 as the end flag.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-310\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_gcode.jpg\" alt=\"\" width=\"334\" height=\"453\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_gcode.jpg 334w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_gcode-221x300.jpg 221w\" sizes=\"(max-width: 334px) 100vw, 334px\" \/><\/p>\n<p>Next, I had to extract the actual numerical values from the G-code strings, which would serve as the basis for further computations. To do this I wrote a function that has the task to find any coordinates labeled with an X or Y in the G-code lines and gather them into two separate lists. The plot below shows the contour of the stringer if we plot the extracted coordinates:<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-319\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_format-coord-1.png\" alt=\"\" width=\"1030\" height=\"377\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_format-coord-1.png 1030w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_format-coord-1-300x110.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_format-coord-1-1024x375.png 1024w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_format-coord-1-768x281.png 768w\" sizes=\"(max-width: 1030px) 100vw, 1030px\" \/><\/p>\n<h2>Placing the Vacuum Clamps<\/h2>\n<p>Let us now look at the real challenge of this project, which was to find a way to position the vacuum clamps on the machine table and how the clamps had to be shifted within the workpiece. My idea was to re-render the contour of the workpiece to fill in the missing values because as you can see in the G-code example above there are big gaps between the points of the original contour. The fine contour is then used to find the position of the clamps inside the workpiece.<\/p>\n<p>My algorithm operates based on the following principle. First, a fictitious line is calculated using the centroid coordinates of the staircase component.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-509\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line.png\" alt=\"\" width=\"1000\" height=\"340\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line.png 882w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line-300x102.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line-768x261.png 768w\" sizes=\"(max-width: 1000px) 100vw, 1000px\" \/><\/p>\n<p>Then, points on the centroid line are sought for the centroids of the two outermost clamps until the distance between the clamps and the contour of the staircase component reaches 4cm.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter wp-image-510\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line-clamp-position.png\" alt=\"\" width=\"1000\" height=\"339\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line-clamp-position.png 885w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line-clamp-position-300x102.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_centroid-line-clamp-position-768x260.png 768w\" sizes=\"(max-width: 1000px) 100vw, 1000px\" \/><\/p>\n<p>If we now plot the clamps, this first step looks like in the image below:<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-318\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s16.png\" alt=\"\" width=\"1030\" height=\"377\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s16.png 1030w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s16-300x110.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s16-1024x375.png 1024w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s16-768x281.png 768w\" sizes=\"(max-width: 1030px) 100vw, 1030px\" \/><\/p>\n<p>The remaining clamps are then placed on the centroid line, offset by the width of one clamp. This results in three clamps on the left and three clamps on the right, as a workpiece is always secured with exactly six clamps.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-320\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s123456.png\" alt=\"\" width=\"1019\" height=\"375\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s123456.png 1019w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s123456-300x110.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_s123456-768x283.png 768w\" sizes=\"(max-width: 1019px) 100vw, 1019px\" \/><\/p>\n<p>As you may have noticed, the clamps on the right have a different spacing than the ones on the left. If we plot the machine table beside the stringer it should become clear why this is the case.<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-325\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_wange-tisch-1.png\" alt=\"\" width=\"997\" height=\"750\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_wange-tisch-1.png 997w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_wange-tisch-1-300x226.png 300w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/positioner_wange-tisch-1-768x578.png 768w\" sizes=\"(max-width: 997px) 100vw, 997px\" \/><\/p>\n<p>It would have been great if the project was finished by now, however, due to the complex machine table, a total of four different algorithms had to be developed since the staircase components can have lengths ranging from 50cm to 6m and sometimes require significantly different positioning of the vacuum clamps within the workpiece and on the machine table. We will look at the different configurations at the end of the article.<\/p>\n<h2>Positioning on the Machine Table<\/h2>\n<p>After calculating the clamping positions, a suitable spot on the machine table had to be chosen. This calculation also depends on the length of the staircase components. In the next step, the zero offsets and the measurements for clamp and raw workpiece placement are calculated. Finally, a plot is made with the positioning of the workpiece relative to the vacuum clamps and the positioning of the vacuum clamps relative to the machine table.<\/p>\n<p>In addition, the plot, which is output in the form of a PDF in A4 format, shows the necessary zero offsets that are fed into the CNC control panel. A finished computation gives a plot like the one below:<\/p>\n<p><img loading=\"lazy\" decoding=\"async\" class=\"aligncenter size-full wp-image-499\" src=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_wange-fertig.jpg\" alt=\"\" width=\"739\" height=\"628\" srcset=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_wange-fertig.jpg 739w, http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_wange-fertig-300x255.jpg 300w\" sizes=\"(max-width: 739px) 100vw, 739px\" \/><\/p>\n<p>As already mentioned we will also look at the other possibilities of workpiece placement which are showcased in this <a href=\"http:\/\/192.168.178.139\/wp-content\/uploads\/2023\/07\/cnc-positioner_parts.pdf\" target=\"_blank\" rel=\"noopener\">PDF<\/a> file.<\/p>\n<h2>Conclusion<\/h2>\n<p>This project will always have a special place in my heart as my first real attempt at developing an actual useful application. Ironically the project probably features the ugliest code that I have ever written but on the other hand, has also created the most value. The application could prevent a thirty thousand euro investment and has effectively reduced the time it takes to process one workpiece by around 25 percent. Additionally, working on the machine is now less error-prone, and training new employees has become faster.<\/p>\n<p>In the years since I developed the positioning script I always played with the thought of refactoring the code, but given the time it would take to entangle the code and the fact that it really works flawlessly so far, I couldn&#8217;t really bother. Of course, you can have a look for yourself, as the code is hosted on <a href=\"https:\/\/github.com\/marco507\/CNC-Workpiece-Positioning\">GitHub<\/a>.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>The starting point for this next project was a defect in one of our CNC portal milling machines at my workplace, which is used for [&#8230;]<\/p>\n","protected":false},"author":2,"featured_media":502,"comment_status":"closed","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[6,1],"tags":[],"_links":{"self":[{"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/posts\/308"}],"collection":[{"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/comments?post=308"}],"version-history":[{"count":10,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/posts\/308\/revisions"}],"predecessor-version":[{"id":694,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/posts\/308\/revisions\/694"}],"wp:featuredmedia":[{"embeddable":true,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/media\/502"}],"wp:attachment":[{"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/media?parent=308"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/categories?post=308"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/192.168.178.139\/wp-json\/wp\/v2\/tags?post=308"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}